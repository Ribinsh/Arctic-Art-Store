<html lang="en">
  <head>
    <title style="color: brown">Arctic</title>
    <meta name="author" content="Zaur" />
    <meta descryption content="Presentation of website" />
    <meta name="keywords" content="technology, cyber security, software" />
    <meta http-equiv="refresh" content="100" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta charset="utf-8" />
    <link rel="stylesheet" href="/stylesheets/home/animate.css" />

    <link rel="stylesheet" href="/public/stylesheets/home/style.css" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/css/bootstrap.min.css"
      integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.9.1/font/bootstrap-icons.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css"
    />
    <link
      href="https://unpkg.com/boxicons@2.1.2/css/boxicons.min.css"
      rel="stylesheet"
    />
                      <!--Sweet alert -->
    <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

    <script src="/js/home/modernizr-2.6.2.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    

    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" rel="stylesheet"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>

  </head>
  <body>
    <%- include ('nav.ejs') %>

    <!-- Checkout Section Begin -->
    <section class="checkout spad">
      <div class="container">
        <div class="checkout__form">
          <div id="checkout-form">
            <div class="row">
              <div class="col-lg-8 col-md-3">
                <h6 class="checkout__title">Billing Details</h6>

                <div class="row gutters-sm">
                  <% if(!newAddress) { %> <% if(address != null) { %>
                  <div class="checkout col-sm-6 mb-3">
                    <div class="card h-100">
                      <div class="card-body">
                        <h6 class="d-flex align-items-center mb-3">
                          <i class="material-icons text-info mr-2"
                            >Delivery Address</i
                          >
                        </h6>
                        <ul class="list-group list-group-flush">
                          <li
                            class="list-group-item d-flex justify-content-between align-items-center flex-wrap"
                          >
                            <h6 class="mb-0"><%= address1.fullName %></h6>
                            <span class="text-secondary"></span>
                          </li>
                          <li
                            class="list-group-item d-flex justify-content-between align-items-center flex-wrap"
                          >
                            <h6 class="mb-0"><%= address1.houseName %></h6>
                            <span class="text-secondary"></span>
                          </li>

                          <li
                            class="list-group-item d-flex justify-content-between align-items-center flex-wrap"
                          >
                            <h6 class="mb-0"><%= address1.city %></h6>
                            <span class="text-secondary"></span>
                          </li>
                          <li
                            class="list-group-item d-flex justify-content-between align-items-center flex-wrap"
                          >
                            <h6 class="mb-0"><%= address1.state %></h6>
                            <span class="text-secondary"></span>
                          </li>
                          <li
                            class="list-group-item d-flex justify-content-between align-items-center flex-wrap"
                          >
                            <h6 class="mb-0"><%= address1.pincode %></h6>
                            <span class="text-secondary">pincode</span>
                          </li>
                          <li
                            class="list-group-item d-flex justify-content-between align-items-center flex-wrap"
                          >
                            <h6 class="mb-0"><%= address1.phone %></h6>
                            <span class="text-secondary"></span>
                          </li>
                          <button class="btn btn-info"  role="button" onclick="showAddress()"  style="margin-top: 1rem">
                            Change Address
                          </button>
                        </ul>
                      </div>
                    </div>
                  </div>





                 

                  <% } %> <% } else { %>

                  <div class="checkout col-sm-6 mb-3">
                    <div class="card h-100">
                      <div class="card-body">
                        <h6 class="d-flex align-items-center mb-3">
                          <i class="material-icons text-info mr-2"
                            >Delivery Address</i
                          >
                        </h6>
                        <ul class="list-group list-group-flush">
                          <li
                            class="list-group-item d-flex justify-content-between align-items-center flex-wrap"
                          >
                            <h6 class="mb-0"><%= address2.fullName %></h6>
                            <span class="text-secondary"></span>
                          </li>
                          <li
                            class="list-group-item d-flex justify-content-between align-items-center flex-wrap"
                          >
                            <h6 class="mb-0"><%= address2.houseName %></h6>
                            <span class="text-secondary"></span>
                          </li>

                          <li
                            class="list-group-item d-flex justify-content-between align-items-center flex-wrap"
                          >
                            <h6 class="mb-0"><%= address2.city %></h6>
                            <span class="text-secondary"></span>
                          </li>
                          <li
                            class="list-group-item d-flex justify-content-between align-items-center flex-wrap"
                          >
                            <h6 class="mb-0"><%= address2.state %></h6>
                            <span class="text-secondary"></span>
                          </li>
                          <li
                            class="list-group-item d-flex justify-content-between align-items-center flex-wrap"
                          >
                            <h6 class="mb-0"><%= address2.pincode %></h6>
                            <span class="text-secondary">pincode</span>
                          </li>
                          <li
                            class="list-group-item d-flex justify-content-between align-items-center flex-wrap"
                          >
                            <h6 class="mb-0"><%= address2.phone %></h6>
                            <span class="text-secondary"></span>
                          </li>
                          <button class="btn btn-info"  onclick="showAddress()" role="button"  style="margin-top: 1rem">
                            Change Address
                          </button>
                        </ul>
                      </div>
                    </div>
                  </div>

                  <% } %>

                  <div class="checkout col-sm-6 mb-3">
                    <div class="card h-100">
                      <div class="card-body">
                        <h6 class="d-flex align-items-center mb-3">
                          <i class="material-icons text-success mr-2"
                            >Deliver to new address</i
                          >
                        </h6>

                        <form action="/newDeliveryAddress" method="post">
                          <ul class="list-group list-group-flush">
                            <li
                              class="list-group-item d-flex justify-content-between align-items-center flex-wrap"
                            >
                              <input
                                class="mb-0"
                                style="outline: 0; border: 0"
                                type="text"
                                name="fullName"
                                placeholder="Name"
                              />
                              <!-- <span class="text-secondary">Name</span> -->
                            </li>
                            <li
                              class="list-group-item d-flex justify-content-between align-items-center flex-wrap"
                            >
                              <input
                                class="mb-0"
                                style="outline: 0; border: 0"
                                type="text"
                                name="houseName"
                                placeholder="House/Office"
                              />
                              <!-- <span class="text-secondary">House/Office</span> -->
                            </li>

                            <li
                              class="list-group-item d-flex justify-content-between align-items-center flex-wrap"
                            >
                              <input
                                class="mb-0"
                                style="outline: 0; border: 0"
                                type="text"
                                name="city"
                                placeholder="City"
                              />
                              <!-- <span class="text-secondary">City</span> -->
                            </li>
                            <li
                              class="list-group-item d-flex justify-content-between align-items-center flex-wrap"
                            >
                              <input
                                class="mb-0"
                                style="outline: 0; border: 0"
                                type="text"
                                name="state"
                                placeholder="State"
                              />
                              <!-- <span class="text-secondary">State</span> -->
                            </li>
                            <li
                              class="list-group-item d-flex justify-content-between align-items-center flex-wrap"
                            >
                              <input
                                class="mb-0"
                                style="outline: 0; border: 0"
                                type="number"
                                name="pincode"
                                placeholder="pincode"
                              />
                              <!-- <span class="text-secondary">pincode</span> -->
                            </li>
                            <li
                              class="list-group-item d-flex justify-content-between align-items-center flex-wrap"
                            >
                              <input
                                class="mb-0"
                                style="outline: 0; border: 0"
                                type="number"
                                name="phone"
                                placeholder="phone"
                              />
                              <!-- <span class="text-secondary" >phone</span> -->
                            </li>
                          </ul>
                          <button
                            type="submit"
                            class="btn btn-success"
                            style="margin-top: 1rem"
                          >
                            Deliver here
                          </button>
                        </form>
                      </div>
                    </div>
                  </div>



                  
                
                 

                  
                </div>

                  <!-- hidden address -->

                <div class="row  gutters-sm"   id="addressList" style="display: none;">
                  <% if(address != null) { %>
                    <div  id="allAddress"  class="row  d-flex "  >
                  <% address.address.forEach(function(expand,index){ %> 
                   
                    <div class="row d-flex checkout col-sm-4 mb-3 ">
                      
                       
                      <div class="card h-100">
                        <div class="card-body">
                          
                          <h6 class="d-flex align-items-center mb-3">
                            <i class="material-icons text-info mr-2"
                              > Address</i
                            ><%= index  %>
                          </h6>
                         
                      
                          <ul class="list-group list-group-flush">
                            <li
                              class="list-group-item d-flex justify-content-between align-items-center flex-wrap"
                            >
                              <h6 class="mb-0"><%= expand.fullName %></h6>
                              <span class="text-secondary"></span>
                            </li>
                            <li
                              class="list-group-item d-flex justify-content-between align-items-center flex-wrap"
                            >
                              <h6 class="mb-0"><%= expand.houseName %></h6>
                              <span class="text-secondary"></span>
                            </li>
  
                            <li
                              class="list-group-item d-flex justify-content-between align-items-center flex-wrap"
                            >
                              <h6 class="mb-0"><%= expand.city %></h6>
                              <span class="text-secondary"></span>
                            </li>
                            <li
                              class="list-group-item d-flex justify-content-between align-items-center flex-wrap"
                            >
                              <h6 class="mb-0"><%= expand.state %></h6>
                              <span class="text-secondary"></span>
                            </li>
                            <li
                              class="list-group-item d-flex justify-content-between align-items-center flex-wrap"
                            >
                              <h6 class="mb-0"><%= expand.pincode %></h6>
                              <span class="text-secondary">pincode</span>
                            </li>
                            <li
                              class="list-group-item d-flex justify-content-between align-items-center flex-wrap"
                            >
                              <h6 class="mb-0"><%= expand.phone %></h6>
                              <span class="text-secondary"></span>
                            </li>
                            <button class="btn btn-outline-info"  type="button" onclick="changeAddress('<%= index %>')">
                              Select
                            </button>
                           
                          </ul>
                          
                        </div>
                      </div>
                     
                    </div>
                    <% }) %>

                  </div>

                    <% } %>
                </div>
              </div>

              <div class="checkout col-lg-4 col-md-6">
                <div class="checkout__order">
                  <h4 class="order__title">Your order</h4>
                  <div class="checkout__order__products">
                    Product <span>Total</span>
                  </div>
                  <% cartProducts.forEach(function(product){ %>
                  <ul class="checkout__total__products">
                    <li>
                      <img
                        style="width: 50px"
                        src="/<%= product.productId.imageUrl %>"
                        alt=""
                      />
                      <span><%=product.productId.category %></span>
                    </li>
                    <li>
                      <%=product.productId.productName %><span>
                        Rs. <%=product.total %></span
                      >
                    </li>
                    <li><span><%= product.quantity %></span></li>
                  </ul>
                  <% }) %>
                  <ul class="checkout__total__all">
                    <li>Subtotal <span>Rs.<%= totalAmount %></span></li>
                    <li>Coupen Discount <span>0</span></li>
                    <li>
                      Delivery charge
                      <span style="color: rgb(34, 228, 73)">Free</span>
                    </li>
                    <li>Total <span>Rs.<%= totalAmount %></span></li>
                  </ul>

                  <!-- <div class="">
                                   <label for="">
                                      <input type="radio" name="payment_method" value="ONLINE"> Online payment
                                </div>
                                <div class="">
                                    <label for="">
                                      <input type="radio" name="payment_method" value="COD">  COD(cash on delivery)
                                    </label>
                                </div> -->
                  <!-- <form action="/orderPlaced" method="get">
                                    <button type="submit" class="site-btn">PLACE ORDER</button>
                                </form> -->
                  <div>
                    <label for="">
                      <input
                        type="radio"
                        id="razorpay"
                        name="payment_method"
                        value="ONLINE"
                        checked
                      />
                      Online payment
                    </label>
                  </div>
                  <div>
                    <label for="">
                      <input
                        type="radio"
                        id="cod"
                        name="payment_method"
                        value="COD"
                      />
                      COD(cash on delivery)
                    </label>
                  </div>
                  <% if( noAddress) { %>
                    <button onclick="order()" type="button" class="site-btn">
                      PLACE ORDER
                    </button>
                    <% } else { %>
                     
                    
                    
                    <% if(!newAddress ) { %>

                  <button
                    onclick="orderPlaced('<%= address1._id %>')"
                    type="button"
                    class="site-btn"
                  >
                    PLACE ORDER
                  </button>
                  <% } else { %>

                  <button
                    onclick="orderPlaced('<%= address2._id %>')"
                    type="button"
                    class="site-btn"
                  >
                    PLACE ORDER
                  </button>

                  <% } %> 

                  <% } %>
                 
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Checkout Section End -->

    <script>
      function orderPlaced(address) {
        let addressId = address;
        let payment_method = document.getElementById("razorpay").checked
          ? "ONLINE"
          : "COD";
        $.ajax({
          url: "/orderPlaced",
          data: {
            addressId: addressId,
            paymentMethod: payment_method,
          },
          method: "post",
          success: (response) => {
            if (response.codSuccess) {
              location.href = "/orderSuccess";
            } else {
              razorpayPayment(response);
            }
          },
        });

        function razorpayPayment(order) {
          var options = {
            key: "rzp_test_V5iFHTFztlUktp", // Enter the Key ID generated from the Dashboard
            amount: order.amount, // Amount is in currency subunits. Default currency is INR. Hence, 50000 refers to 50000 paise
            currency: "INR",
            name: "Arctic store",
            description: "Test Transaction",
            image: "Images\nav-logo.jpeg",
            order_id: order.id, //This is a sample Order ID. Pass the `id` obtained in the response of Step 1
            callback_url: "https://eneqd3r9zrjok.x.pipedream.net/",
            handler: function (response) {
              // alert(response.razorpay_payment_id);
              // alert(response.razorpay_order_id);
              // alert(response.razorpay_signature)
              verifyPayment(response, order);
            },
            prefill: {
              name: "Ribinsh",
              email: "ribinshp7@gmail.com",
              contact: "8714350500",
            },
            notes: {
              address: "Razorpay Corporate Office",
            },
            theme: {
              color: "#7c7efc",
            },
          };
          function verifyPayment(payment, order) {
            $.ajax({
              url: "/verifyPayment",
              data: {
                payment,
                order,
              },
              method: "post",
              success: (response) => {
                if (response.status) {
                  location.href = "/orderSuccess";
                } else {
                  Swal.fire({
                    icon: "error",
                    title: "Oops...",
                    text: "Something went wrong!",
                  });
                }
              },
            });
          }

          var rzp1 = new Razorpay(options);
          rzp1.open();
        }
      }

      function order() {
        Swal.fire({
                    icon: "error",
                    title: "Oops...",
                    text: "Address not added",
        })
      }

      function changeAddress(index){
        $.ajax({
          url: "/changeAddress",
          data : {
            index 
          },
          method : "post",
          success : (response) => {
            location.href ='/checkout'
          }
        })
      }

      function showAddress(){
    const addressData = document.querySelector("#addressList")

    if(addressData.style.display == "none") {
      addressData.style.display = "block"
    } else {
      addressData.style.display = "none"
    }
    }
    </script>


    

    <%- include ('userFooter') %>
  </body>
</html>
